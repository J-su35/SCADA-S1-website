$(document).ready(function() {

    function getUrlParameter(sParam)
    {
        var sPageURL = window.location.search.substring(1);
        var sURLVariables = sPageURL.split('&');
        for (var i = 0; i < sURLVariables.length; i++)
        {
            var sParameterName = sURLVariables[i].split('=');
            if (sParameterName[0] == sParam)
            {
                return sParameterName[1];
            }
        }
    }

    $( "#datepicker" ).datepicker({
        dateFormat: 'dd-mm-yy',
        maxDate: '0',
        minDate: new Date(2014, 8, 19)
    });

    /*$( "#datepicker2" ).datepicker({
        dateFormat: 'dd-mm-yy'
    });*/

    showCurve();

    /*$('#datepicker').change(function() {
        var chart = $('#load-chart').highcharts();
        chart.showLoading();
        var hasData = showCurve();
        return false;
    });*/

    $('#datepicker').change(function() {
        updateChart2('date','');
    });

    $("#area_selector").change(function(){
        updateChart2('area','');
        var value = $("#area_selector").val();
        if (value == "Total") {
            $("#province_selector").hide();
        } else {
            $("#province_selector").show();
        }
    });

    $("#province_selector").change(function(){
        updateChart2('province');
    });

    /*$("#area_selector").change(function(){
        var chart = $('#load-chart').highcharts();
        chart.showLoading();
        var hasData = showCurve();
        return false;
    });*/
    function updateChart2(updateFrom){
        //var chart = $('#load-chart').highcharts();
        //chart.showLoading();
        showCurve(updateFrom);
        //chart.hideLoading();
    }

    function updateChart(updateFrom){
        var province = '';
        if(updateFrom == 'area'){
            province = 'Total';
        }
        else{
            province = $("#province_selector").val();
        }
        var chart = $('#load-chart').highcharts();
        chart.showLoading();
        $.getJSON('data.php',{date: $("#datepicker").val(), mode: 'province', area: $("#area_selector").val(), province: province}, function(data) {
            var regions = data['name'];

            //for (i = 0; i < regions.length; i++) {
                chart.series[0].setData(data['values'][regions], false);
            //}
            //chart.series[regions.length].setData(data['values']['Total'], false);

            var chartHeader = '';
            if($("#area_selector").val() == "Total"){
                if($("#province_selector").val() == "Total"){
                    chartHeader = 'โหลดรวมของทุกเขต';
                }
            }
            else{
                if($("#province_selector").val() == "Total"){
                    chartHeader = 'โหลดรวมของเขต '+$("#area_selector option:selected").text();
                }
                else{
                    chartHeader = 'โหลดของจังหวัด'+$("#province_selector option:selected").text();
                }
            }
            chart.setTitle({text: chartHeader});

            chart.redraw();
            chart.hideLoading();
        });
    }

    function showCurve(updateFrom){
        $("#spantext").text("กรุณารอสักครู่ กำลังโหลดข้อมูล...").fadeIn();
        var province = '';
        if(updateFrom == 'area'){
            province = 'Total';
            //$("#province_selector").hide();
        }
        else{
            province = $("#province_selector").val();
        }
        /*var startArea = getUrlParameter('area');
        if(startArea != null){
            $("#area_selector").val(startArea).change();
        }*/
        $.getJSON('data.php',{date: $("#datepicker").val(), mode: 'province', area: $("#area_selector").val(), province: province}, function(data) {
            //alert(data['SubID']);
            if(data['available'] == 1){
                /*var chart = $('#load-chart').highcharts();
                chart.destroy();
                chart = new Highcharts.Chart(defaultOptions);*/
                $("#spantext").text('ไม่มีข้อมูล');
                $("#load-chart").hide();
                return;
            }else{
                $("#spantext").hide();
                $("#load-chart").show();
            }
            var regions = data['name'];
            if(data['12Area'] == 1){
                regions = ['N1','N2','N3','NE1','NE2','NE3','C1','C2','C3','S1','S2','S3','Total','Peak','Yesterday'];
            }
            var provinceName = data['label'];
            var series = [];
            var colorSPPVSPP = ['#1b32de', '#4978e2', '#0e7b14', '#50cf77', '#BB1010'];
            var colorSPPVSPPType = ['#4A89DC','#37BC9B','#F6BB42','#DA4453','#D770AD','#3BAFDA','#8CC152','#E9573F','#967ADC','#5D9CEC','#48CFAD','#F6BB42','#ED5565','#EC87C0','#4FC1E9','#A0D468','#FC6E51','#AC92EC','#BB1010'];
            var colorBootflatSecond = ['#4A89DC','#8CC152','#F6BB42','#E9573F','#967ADC','#3BAFDA','#DA4453','#37BC9B','#D770AD'];
            var colorSet = [];
            var chartHeader = '';
            var legendSetting = {};
            var date = $("#datepicker").val().split("-");
            var day = date[0]+'/'+date[1]+'/'+date[2];

            if($("#area_selector").val() == "Total"){
                chartHeader = 'โหลดรวมของทุกเขต'+' วันที่ '+ day;
            }
            else{
                if ($("#province_selector").val() == "Total") {
                    chartHeader = 'โหลดรวมของเขต '+$("#area_selector option:selected").text()+' วันที่ '+ day;
                }else{
                    chartHeader = 'โหลดของจังหวัด'+$("#province_selector option:selected").text()+' วันที่ '+ day;
                }
            }

            /*series.push({
                type: 'areaspline',
                name: provinceName,
                data: data['values'][regions],
            });*/

            //alert(regions);
			//alert(provinceName);

            //Fix Peak Load in 2015
            var fixLoad2015 = {};
            var C1 = [3677.21,3653.97,3655.54,3611.04,3588.78,3549.64,3476.84,3460.45,3422.99,3429.44,3463.62,3502.36,3455.35,3398.75,3413.16,3286.13,3513.45,3535.32,3546.37,3556.35,3560.99,3591.5,3602.15,3570.13,3457.06,3464.17,3665.79,3664.02,3685.53,3668.22,3656.92,3665.59,3642.61,3580,3486.58,3532.69,3544.04,3671.53,3782.46,3804.76,3807.48,3831.29,3787.31,3763.23,3794.95,3831.46,3760.67,3756.01];
            var C2 = [3569.72,3534.55,3518.92,3492.24,3476.24,3505.76,3402.24,3360.29,3378.34,3375.73,3271.8,3279.2,3301.92,3378,3335.48,3412.19,3559.47,3895.13,3774.73,3838.83,3830.05,3906.71,3869.32,3765.72,3513.5,3523.57,3894.49,3863.07,3900.06,3907.41,3871.74,3890.01,3872.67,3661.68,3443.34,3458.16,3480.31,3583.35,3627.83,3582.69,3553.22,3667.42,3650.66,3633.6,3776.47,3819.4,3771.52,3715.85];
            var C3 = [1608.88,1606.3,1598.47,1594.41,1575.13,1540.37,1512.76,1475.64,1475.39,1482.79,1508.23,1530.94,1531.05,1506.31,1513.96,1561.37,1702.84,1798.2,1827.04,1843.62,1870.26,1891.43,1902.53,1867.45,1708.13,1708.77,1944.83,1962.9,1980.32,1972.06,1939.15,1928.51,1888.89,1781.62,1677.98,1687.41,1676.15,1746.87,1821.02,1804,1772.14,1793.08,1783.05,1766.84,1799.16,1821.06,1780.72,1758.31];
            var N1 = [1023.486023,991.633606,953.438965,915.091248,883.345825,867.658447,849.230164,813.055176,798.955994,792.419495,788.119995,796.295654,824.016663,826.41864,813.163452,804.292969,841.432312,907.385742,950.069824,985.970947,1014.630981,1038.563843,1072.666748,1088.575073,1090.029663,1075.258911,1067.880371,1134.350342,1161.96875,1159.14502,1154.589355,1170.228638,1165.444214,1143.119751,1114.888916,1049.351196,999.9328,1009.765259,1154.478271,1204.955322,1210.513794,1211.221191,1216.456909,1207.251831,1185.422363,1166.376709,1149.36853,1105.448364];
            var N2 = [962.546509,926.491272,901.101257,875.483582,848.13739,828.97644,806.181885,790.539185,776.273499,765.655823,775.709961,816.500916,851.0271,847.517883,774.34082,728.138794,729.490112,761.778992,795.848328,813.431946,834.096497,853.461426,854.859131,869.199768,866.280701,849.012878,855.172668,919.876648,935.237732,939.386963,947.632019,941.613281,946.996765,938.956055,917.006348,862.881775,840.525391,871.463013,1014.470886,1061.432129,1079.416382,1095.815796,1121.57373,1119.213623,1086.7854,1060.154907,1039.695679,999.775024];
            var N3 = [760.02,738.41,727.67,688.04,693.55,688.28,659.25,661.63,642.08,651.81,658.47,697.5,692.38,638.04,619.18,585.68,627.75,633.78,662.83,699.28,720.11,738.63,756,753.49,742.83,745.62,780.41,779.76,778.93,766.09,748.11,738.12,717.65,692.71,649.19,655.29,676.02,744.5,827.83,842.82,850.03,861.5,856.95,842.88,852.83,837.22,820.86,803.12];
            var NE1 = [829.493225,802.763855,778.257202,750.688843,732.829407,713.962402,699.096436,679.12439,664.758301,654.732239,655.323792,673.506409,657.615295,625.303772,602.394653,599.696472,625.858154,674.722839,715.272705,740.224121,764.127808,783.487427,793.804565,799.066528,772.974731,750.367188,777.648376,837.75116,897.685242,920.333008,909.451172,884.923218,853.952393,838.888306,750.956055,735.294983,707.471069,835.619324,946.001831,953.773682,972.389343,944.048828,915.162292,879.543213,857.152893,837.094788,809.210388,769.67981];
            var NE2 = [681.38678,659.738892,664.154968,653.885071,638.398743,635.23114,623.367737,613.04187,591.780151,603.227051,607.860413,620.10022,599.306335,583.270325,571.639709,593.35907,585.081543,609.762451,655.658081,663.001953,705.177673,692.884094,705.294434,707.658936,715.265869,697.291382,702.805054,727.653198,741.588623,736.438477,733.526306,712.736877,716.53064,689.956787,682.457947,619.640442,645.5177,746.401855,786.89679,815.96814,822.626404,806.239929,812.885559,786.30304,756.74884,712.103943,702.53064,666.847412];
            var NE3 = [1193.094116,1172.39563,1154.105225,1118.264648,1111.059204,1088.714966,1079.446777,1060.301392,1052.588501,1056.194946,1065.0979,1102.004883,1109.471191,1051.807373,1054.081787,1040.027588,1067.7677,1148.200562,1222.201538,1227.902832,1239.451172,1267.21582,1288.914551,1292.69873,1243.444214,1232.227051,1245.680298,1242.598267,1293.599487,1283.679565,1291.887329,1273.709595,1228.516235,1217.821411,1147.570435,1140.791504,1116.402954,1119.317505,1249.921631,1262.151733,1262.577393,1264.265747,1300.21167,1254.04126,1244.790894,1247.361694,1257.488892,1226.616333];
            var S1 = [614.62,617.16,593.13,582.18,570.24,557.93,551.71,536.93,535.66,549.33,561.46,578.67,586.54,567.88,535.47,551.58,555.89,547.05,564.84,568.73,567.7,577.66,570.44,558.77,520.35,533.77,581.92,589.68,597.6,598.02,593.22,587.46,579.72,530.55,500.34,493.31,496.03,551.58,610.79,615.44,613.47,610.2,597.05,587.36,592.6,600.23,620.58,629.31];
            var S2 = [1091.555298,1059.568115,1035.341797,1013.546448,992.111328,977.170227,967.274231,952.036255,944.997681,934.247314,926.106934,947.213013,975.460938,952.931213,912.484436,946.654419,969.066162,1045.214844,1097.863159,1116.321289,1163.162964,1181.427246,1197.943481,1190.646118,1163.4552,1154.84729,1172.183716,1238.322144,1244.125366,1249.797363,1235.562866,1221.078003,1196.040283,1174.873535,1118.756104,1094.420288,1084.348877,1139.723267,1284.196289,1296.962524,1275.405518,1279.410156,1249.341187,1238.807617,1228.857178,1219.933472,1198.549194,1140.928833];
            var S3 = [729.375305,719.769775,700.459412,685.627075,672.482483,654.740601,651.032471,641.706848,632.776245,632.615723,644.557007,657.125732,667.608826,636.678223,602.559692,614.946472,647.004272,685.072388,724.56665,755.534302,768.435059,786.895325,767.318359,806.320068,739.823364,730.160522,742.688354,813.344971,811.981018,794.526611,782.428467,771.495544,761.302795,733.078857,669.1745,635.26416,684.778564,764.378601,829.635315,822.221436,814.93042,789.237671,813.078735,782.233459,771.077637,776.979858,759.687134,731.536499];
            fixLoad2015['0420'] = {C1,C2,C3,N1,N2,N3,NE1,NE2,NE3,S1,S2,S3};
            C1 = [3677.21,3653.97,3655.54,3611.04,3588.78,3549.64,3476.84,3460.45,3422.99,3429.44,3463.62,3502.36,3455.35,3398.75,3413.16,3286.13,3513.45,3535.32,3546.37,3556.35,3560.99,3591.5,3602.15,3570.13,3457.06,3464.17,3665.79,3664.02,3685.53,3668.22,3656.92,3665.59,3642.61,3580,3486.58,3532.69,3544.04,3671.53,3782.46,3804.76,3807.48,3831.29,3787.31,3763.23,3794.95,3831.46,3760.67,3756.01];
            C2 = [3569.72,3534.55,3518.92,3492.24,3476.24,3505.76,3402.24,3360.29,3378.34,3375.73,3271.8,3279.2,3301.92,3378,3335.48,3412.19,3559.47,3895.13,3774.73,3838.83,3830.05,3906.71,3869.32,3765.72,3513.5,3523.57,3894.49,3863.07,3900.06,3907.41,3871.74,3890.01,3872.67,3661.68,3443.34,3458.16,3480.31,3583.35,3627.83,3582.69,3553.22,3667.42,3650.66,3633.6,3776.47,3819.4,3771.52,3715.85];
            C3 = [1608.88,1606.3,1598.47,1594.41,1575.13,1540.37,1512.76,1475.64,1475.39,1482.79,1508.23,1530.94,1531.05,1506.31,1513.96,1561.37,1702.84,1798.2,1827.04,1843.62,1870.26,1891.43,1902.53,1867.45,1708.13,1708.77,1944.83,1962.9,1980.32,1972.06,1939.15,1928.51,1888.89,1781.62,1677.98,1687.41,1676.15,1746.87,1821.02,1804,1772.14,1793.08,1783.05,1766.84,1799.16,1821.06,1780.72,1758.31];
            N1 = [1023.486023,991.633606,953.438965,915.091248,883.345825,867.658447,849.230164,813.055176,798.955994,792.419495,788.119995,796.295654,824.016663,826.41864,813.163452,804.292969,841.432312,907.385742,950.069824,985.970947,1014.630981,1038.563843,1072.666748,1088.575073,1090.029663,1075.258911,1067.880371,1134.350342,1161.96875,1159.14502,1154.589355,1170.228638,1165.444214,1143.119751,1114.888916,1049.351196,999.9328,1009.765259,1154.478271,1204.955322,1210.513794,1211.221191,1216.456909,1207.251831,1185.422363,1166.376709,1149.36853,1105.448364];
            N2 = [962.546509,926.491272,901.101257,875.483582,848.13739,828.97644,806.181885,790.539185,776.273499,765.655823,775.709961,816.500916,851.0271,847.517883,774.34082,728.138794,729.490112,761.778992,795.848328,813.431946,834.096497,853.461426,854.859131,869.199768,866.280701,849.012878,855.172668,919.876648,935.237732,939.386963,947.632019,941.613281,946.996765,938.956055,917.006348,862.881775,840.525391,871.463013,1014.470886,1061.432129,1079.416382,1095.815796,1121.57373,1119.213623,1086.7854,1060.154907,1039.695679,999.775024];
            N3 = [760.02,738.41,727.67,688.04,693.55,688.28,659.25,661.63,642.08,651.81,658.47,697.5,692.38,638.04,619.18,585.68,627.75,633.78,662.83,699.28,720.11,738.63,756,753.49,742.83,745.62,780.41,779.76,778.93,766.09,748.11,738.12,717.65,692.71,649.19,655.29,676.02,744.5,827.83,842.82,850.03,861.5,856.95,842.88,852.83,837.22,820.86,803.12];
            NE1 = [829.493225,802.763855,778.257202,750.688843,732.829407,713.962402,699.096436,679.12439,664.758301,654.732239,655.323792,673.506409,657.615295,625.303772,602.394653,599.696472,625.858154,674.722839,715.272705,740.224121,764.127808,783.487427,793.804565,799.066528,772.974731,750.367188,777.648376,837.75116,897.685242,920.333008,909.451172,884.923218,853.952393,838.888306,750.956055,735.294983,707.471069,835.619324,946.001831,953.773682,972.389343,944.048828,915.162292,879.543213,857.152893,837.094788,809.210388,769.67981];
            NE2 = [681.38678,659.738892,664.154968,653.885071,638.398743,635.23114,623.367737,613.04187,591.780151,603.227051,607.860413,620.10022,599.306335,583.270325,571.639709,593.35907,585.081543,609.762451,655.658081,663.001953,705.177673,692.884094,705.294434,707.658936,715.265869,697.291382,702.805054,727.653198,741.588623,736.438477,733.526306,712.736877,716.53064,689.956787,682.457947,619.640442,645.5177,746.401855,786.89679,815.96814,822.626404,806.239929,812.885559,786.30304,756.74884,712.103943,702.53064,666.847412];
            NE3 = [1193.094116,1172.39563,1154.105225,1118.264648,1111.059204,1088.714966,1079.446777,1060.301392,1052.588501,1056.194946,1065.0979,1102.004883,1109.471191,1051.807373,1054.081787,1040.027588,1067.7677,1148.200562,1222.201538,1227.902832,1239.451172,1267.21582,1288.914551,1292.69873,1243.444214,1232.227051,1245.680298,1242.598267,1293.599487,1283.679565,1291.887329,1273.709595,1228.516235,1217.821411,1147.570435,1140.791504,1116.402954,1119.317505,1249.921631,1262.151733,1262.577393,1264.265747,1300.21167,1254.04126,1244.790894,1247.361694,1257.488892,1226.616333];
            S1 = [614.62,617.16,593.13,582.18,570.24,557.93,551.71,536.93,535.66,549.33,561.46,578.67,586.54,567.88,535.47,551.58,555.89,547.05,564.84,568.73,567.7,577.66,570.44,558.77,520.35,533.77,581.92,589.68,597.6,598.02,593.22,587.46,579.72,530.55,500.34,493.31,496.03,551.58,610.79,615.44,613.47,610.2,597.05,587.36,592.6,600.23,620.58,629.31];
            S2 = [1091.555298,1059.568115,1035.341797,1013.546448,992.111328,977.170227,967.274231,952.036255,944.997681,934.247314,926.106934,947.213013,975.460938,952.931213,912.484436,946.654419,969.066162,1045.214844,1097.863159,1116.321289,1163.162964,1181.427246,1197.943481,1190.646118,1163.4552,1154.84729,1172.183716,1238.322144,1244.125366,1249.797363,1235.562866,1221.078003,1196.040283,1174.873535,1118.756104,1094.420288,1084.348877,1139.723267,1284.196289,1296.962524,1275.405518,1279.410156,1249.341187,1238.807617,1228.857178,1219.933472,1198.549194,1140.928833];
            S3 = [729.375305,719.769775,700.459412,685.627075,672.482483,654.740601,651.032471,641.706848,632.776245,632.615723,644.557007,657.125732,667.608826,636.678223,602.559692,614.946472,647.004272,685.072388,724.56665,755.534302,768.435059,786.895325,767.318359,806.320068,739.823364,730.160522,742.688354,813.344971,811.981018,794.526611,782.428467,771.495544,761.302795,733.078857,669.1745,635.26416,684.778564,764.378601,829.635315,822.221436,814.93042,789.237671,813.078735,782.233459,771.077637,776.979858,759.687134,731.536499];
            fixLoad2015['0421'] = {C1,C2,C3,N1,N2,N3,NE1,NE2,NE3,S1,S2,S3};
            fixLoad2015['0422'] = {C1,C2,C3,N1,N2,N3,NE1,NE2,NE3,S1,S2,S3};
            fixLoad2015['0423'] = {C1,C2,C3,N1,N2,N3,NE1,NE2,NE3,S1,S2,S3};
            //alert(fixLoad2015['0421'].C1);

            for (i = 0; i < regions.length; i++) {
                if(regions[i] == 'Total'){
                    series.push({
                        type: 'spline',
                        name: 'Total',
                        data: data['values']['Total'],
                    });
                }
                else if(regions[i] == 'Peak'){
					series.push({
                        type: 'spline',
                        name: provinceName[i],
                        data: data['values']['Peak'],
                    });
				}
				else if(regions[i] == 'Yesterday'){
					series.push({
                        type: 'spline',
                        name: 'Yesterday',
                        data: data['values']['Yesterday'],
                    });
				}
				else{
                    series.push({
                        type: 'areaspline',
                        name: provinceName[i],
                        data: data['values'][regions[i]],
                    });
                }
            }

            /*series.push({
                type: 'spline',
                name: 'Total',
                data: data['values']['Total'],
            });*/
            //$('#province-info').html(provinceInfo);

            /*series.push({
                type: 'spline',
                name: 'Base Load',
                data: data['base'],
                visible: true
            });*/

            $('#load-chart').highcharts({
                chart: {
                    renderTo: 'load-chart',
                    animation: { duration: 1000 },
                },
                colors: colorBootflatSecond,
                title: {
                    text: chartHeader,
                    //margin: 10
                },
                subtitle: {
                    //text: 'ที่มา: ระบบ SCADA/DMS'
                },
                legend: legendSetting,
                series: series,
                xAxis: {
                    categories: data['categories'],
                    tickInterval: 4,
                    tickmarkPlacement: 'on',
                },
                yAxis: { // Primary yAxis
                    labels: {
                        formatter: function() {
                            return format('#,###.', this.value);
                        },
                    },
                    title: {
                        text: 'ปริมาณกำลังผลิตรวม (MW)',
                    }
                },
                tooltip: {
                    shared: true,
                    /*formatter: function() {
                        var s = this.x +' น.';
                        var sum = 0;

                        $.each(this.points, function(i, point) {
                            s += '<br/><span style="color: ' + point.series.color + ';">' + point.series.name + '</span>: <strong>'+ format('#,###.##', point.y) + ' MW</strong>';
                            if (point.series.name != 'Base Load') {
                                sum += point.y;
                            }
                            else {
                                s += '<br/> ';
                            }
                        });

                        //s += '<br/><br/>Area total: <strong>' + sum.toFixed(2) + ' MW</strong>';
                        return s;
                    }
                    //valueSuffix: ' MW',
                    /*formatter: function() {
                        return '' + this.x + ': ' + $.format.number(this.y, '#,###') + ' MW';
                    }*/
                },
                credits: {
                    enabled: false
                },
                plotOptions: {
                    series: {
                        marker: {
                            enabled: false
                        },
                        //visible: false
                    },
                    areaspline: {
                        stacking: 'normal'
                    }
                }
            });
        });
    }
});
